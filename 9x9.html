<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>數獨遊戲 Sudoku (離線版)</title>
  <style>
    /* --- 100% 離線內建樣式 --- */
    :root {
      --bg-main: #f8fafc;
      --text-main: #1e293b;
      --board-bg: #1e293b;
      --cell-bg: #ffffff;
      --cell-selected: #bfdbfe;
      --cell-same: #dbeafe;
      --cell-related: #f1f5f9;
      --cell-conflict: #fee2e2;
      --text-initial: #0f172a;
      --text-user: #2563eb;
      --text-conflict: #dc2626;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      padding: 30px 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      max-width: 400px;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      letter-spacing: 1px;
    }

    .subtitle {
      font-size: 14px;
      color: #64748b;
      margin: 4px 0 0;
    }

    select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      outline: none;
      background: white;
      cursor: pointer;
    }

    /* 勝利提示 */
    .alert-win {
      background: #dcfce3;
      border: 1px solid #86efac;
      color: #166534;
      padding: 16px;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      font-weight: bold;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(-15%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
      50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); }
    }

    .hidden { display: none !important; }

    /* 棋盤區域 */
    .board-container {
      background: white;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 1px;
      background: var(--board-bg);
      border: 4px solid var(--board-bg);
    }

    .cell {
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      background: var(--cell-bg);
      transition: background-color 0.15s;
    }

    @media (max-width: 400px) {
      .cell { font-size: 18px; }
    }

    /* 粗邊界處理 (九宮格) */
    .border-r { border-right: 2px solid var(--board-bg); }
    .border-b { border-bottom: 2px solid var(--board-bg); }

    /* 儲存格狀態顏色 */
    .selected { background: var(--cell-selected) !important; }
    .conflict-bg { background: var(--cell-conflict) !important; }
    .same-num { background: var(--cell-same) !important; }
    .related { background: var(--cell-related) !important; }

    /* 文字狀態顏色 */
    .initial { font-weight: 700; color: var(--text-initial); }
    .user-input { font-weight: 600; color: var(--text-user); }
    .conflict-text { font-weight: 700; color: var(--text-conflict) !important; }

    /* 數字鍵盤 */
    .numpad {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 24px;
    }

    .btn {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 14px 0;
      font-size: 22px;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      touch-action: manipulation;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.1s;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn:active { transform: scale(0.95); }
    .btn:hover { background: #eff6ff; color: #1d4ed8; border-color: #93c5fd; }
    
    .btn-eraser { background: #f1f5f9; color: #475569; }
    .btn-eraser:hover { background: #e2e8f0; border-color: #cbd5e1; color: #334155; }

    /* 控制按鈕 */
    .controls {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
    }

    .btn-primary {
      flex: 1;
      background: #2563eb;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.1s;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
    }
    .btn-primary:active { transform: scale(0.95); background: #1d4ed8; }

    .btn-secondary {
      flex: 1;
      background: white;
      color: #334155;
      border: 1px solid #cbd5e1;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .btn-secondary:active { transform: scale(0.95); background: #f8fafc; }

    /* 提示區塊 */
    .info-box {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 12px;
      display: flex;
      gap: 12px;
      font-size: 14px;
      color: #64748b;
      line-height: 1.6;
    }
    .info-icon { flex-shrink: 0; color: #94a3b8; }
  </style>
</head>
<body>

  <div class="container">
    <!-- 頭部資訊 -->
    <header class="header">
      <div>
        <h1 class="title">數獨 Sudoku</h1>
        <p class="subtitle">訓練你的邏輯與大腦</p>
      </div>
      <div>
        <select id="difficulty-select">
          <option value="0">入門</option>
          <option value="1" selected>簡單</option>
          <option value="2">中等</option>
          <option value="3">困難</option>
          <option value="4">大師</option>
        </select>
      </div>
    </header>

    <!-- 勝利提示 (預設隱藏) -->
    <div id="win-message" class="alert-win hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
      <span>恭喜！你成功解開了數獨！</span>
    </div>

    <!-- 數獨棋盤 -->
    <div class="board-container">
      <div id="sudoku-board" class="board">
        <!-- 盤面會由 JS 動態生成 -->
      </div>
    </div>

    <!-- 數字鍵盤 -->
    <div id="numpad" class="numpad">
      <!-- 數字鍵盤由 JS 生成 -->
    </div>

    <!-- 控制按鈕 -->
    <div class="controls">
      <button onclick="startNewGame()" class="btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>
        新遊戲
      </button>
      <button onclick="restartGame()" class="btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21v-5h5"/></svg>
        重新開始
      </button>
    </div>
    
    <!-- 操作提示 -->
    <div class="info-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
      <div>
        <strong>提示：</strong> 您可以使用滑鼠點擊格子與下方數字鍵盤，或是直接點擊格子後使用<strong style="color: #334155;">實體鍵盤的數字鍵 (1-9)</strong> 進行填寫，方向鍵可移動游標，Backspace 或 Delete 可清除數字。
      </div>
    </div>
  </div>

  <script>
    // --- 數獨核心邏輯與狀態管理 ---
    const getEmptyBoard = () => Array.from({ length: 9 }, () => Array(9).fill(0));

    const DIFFICULTIES = [
      { label: '入門', holes: 20 },
      { label: '簡單', holes: 35 },
      { label: '中等', holes: 45 },
      { label: '困難', holes: 55 },
      { label: '大師', holes: 62 },
    ];

    let initialBoard = getEmptyBoard();
    let board = getEmptyBoard();
    let selectedCell = null; // { r, c }
    let isWon = false;

    // 檢查合法性
    const isValid = (checkBoard, row, col, num) => {
      for (let x = 0; x < 9; x++) {
        if (checkBoard[row][x] === num) return false;
        if (checkBoard[x][col] === num) return false;
      }
      const startRow = Math.floor(row / 3) * 3;
      const startCol = Math.floor(col / 3) * 3;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          if (checkBoard[startRow + i][startCol + j] === num) return false;
        }
      }
      return true;
    };

    // 回溯法生成
    const solveAndFill = (genBoard) => {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (genBoard[row][col] === 0) {
            const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
            for (let num of nums) {
              if (isValid(genBoard, row, col, num)) {
                genBoard[row][col] = num;
                if (solveAndFill(genBoard)) return true;
                genBoard[row][col] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    };

    // 檢查衝突
    const checkConflict = (checkBoard, row, col) => {
      const num = checkBoard[row][col];
      if (num === 0) return false;
      checkBoard[row][col] = 0;
      const valid = isValid(checkBoard, row, col, num);
      checkBoard[row][col] = num;
      return !valid;
    };

    // 檢查勝利
    const checkWinCondition = (checkBoard) => {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (checkBoard[r][c] === 0 || checkConflict(checkBoard, r, c)) {
            return false;
          }
        }
      }
      return true;
    };

    // --- UI 渲染與事件處理 ---

    function startNewGame() {
      const diffIndex = parseInt(document.getElementById('difficulty-select').value);
      const fullBoard = getEmptyBoard();
      solveAndFill(fullBoard);

      const gameBoard = fullBoard.map(row => [...row]);
      let holesToRemove = DIFFICULTIES[diffIndex].holes;

      while (holesToRemove > 0) {
        const r = Math.floor(Math.random() * 9);
        const c = Math.floor(Math.random() * 9);
        if (gameBoard[r][c] !== 0) {
          gameBoard[r][c] = 0;
          holesToRemove--;
        }
      }

      initialBoard = gameBoard.map(row => [...row]);
      board = gameBoard.map(row => [...row]);
      selectedCell = null;
      isWon = false;
      
      updateUI();
    }

    function restartGame() {
      board = initialBoard.map(row => [...row]);
      selectedCell = null;
      isWon = false;
      updateUI();
    }

    function handleInput(num) {
      if (!selectedCell || isWon) return;
      const { r, c } = selectedCell;
      
      if (initialBoard[r][c] !== 0) return;

      board[r][c] = num;

      if (checkWinCondition(board)) {
        isWon = true;
      }
      updateUI();
    }

    function updateUI() {
      renderBoard();
      const winMsg = document.getElementById('win-message');
      if (isWon) {
        winMsg.classList.remove('hidden');
      } else {
        winMsg.classList.add('hidden');
      }
    }

    function renderBoard() {
      const boardContainer = document.getElementById('sudoku-board');
      boardContainer.innerHTML = '';
      const selectedNumber = selectedCell ? board[selectedCell.r][selectedCell.c] : null;

      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          const cellValue = board[r][c];
          const isInitial = initialBoard[r][c] !== 0;
          const isSelected = selectedCell?.r === r && selectedCell?.c === c;
          const isSameNumber = cellValue !== 0 && cellValue === selectedNumber;
          const isConflicting = !isInitial && checkConflict(board, r, c);
          
          const isRelated = selectedCell && !isSelected && (
            selectedCell.r === r || 
            selectedCell.c === c ||
            (Math.floor(selectedCell.r / 3) === Math.floor(r / 3) && Math.floor(selectedCell.c / 3) === Math.floor(c / 3))
          );

          const cell = document.createElement('div');
          
          let classes = ["cell"];
          if (c % 3 === 2 && c !== 8) classes.push("border-r");
          if (r % 3 === 2 && r !== 8) classes.push("border-b");

          if (isSelected) classes.push("selected");
          else if (isConflicting) classes.push("conflict-bg");
          else if (isSameNumber) classes.push("same-num");
          else if (isRelated) classes.push("related");

          if (isInitial) {
            classes.push("initial");
          } else {
            classes.push("user-input");
            if (isConflicting) classes.push("conflict-text");
          }

          cell.className = classes.join(' ');
          cell.textContent = cellValue !== 0 ? cellValue : '';
          
          cell.onclick = () => {
            selectedCell = { r, c };
            updateUI();
          };

          boardContainer.appendChild(cell);
        }
      }
    }

    function renderNumpad() {
      const numpad = document.getElementById('numpad');
      numpad.innerHTML = '';
      
      for (let i = 1; i <= 9; i++) {
        const btn = document.createElement('button');
        btn.className = "btn";
        btn.textContent = i;
        btn.onclick = () => handleInput(i);
        numpad.appendChild(btn);
      }

      const eraser = document.createElement('button');
      eraser.className = "btn btn-eraser";
      eraser.title = "擦除";
      eraser.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>`;
      eraser.onclick = () => handleInput(0);
      numpad.appendChild(eraser);
    }

    window.addEventListener('keydown', (e) => {
      if (e.key >= '1' && e.key <= '9') {
        handleInput(parseInt(e.key));
      } else if (e.key === 'Backspace' || e.key === 'Delete') {
        handleInput(0);
      } else if (selectedCell) {
        let { r, c } = selectedCell;
        if (e.key === 'ArrowUp') r = Math.max(0, r - 1);
        if (e.key === 'ArrowDown') r = Math.min(8, r + 1);
        if (e.key === 'ArrowLeft') c = Math.max(0, c - 1);
        if (e.key === 'ArrowRight') c = Math.min(8, c + 1);
        selectedCell = { r, c };
        updateUI();
      }
    });

    document.getElementById('difficulty-select').addEventListener('change', startNewGame);

    // 初始化
    renderNumpad();
    startNewGame();

  </script>
</body>
</html>